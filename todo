
[x] Make PURGE work!

[ ] adding a cell that is NOT in memory and NOT on disk should make
    an error!


[x] Polys and line currently have double xy dups at end of line in some cases.

[ ] allow ":r 90" in addition to ":r90" (probably need to fix opt_parse() to
    work like getopts.  Instead of "XWR" need "XnWnRn", maybe allow 
    n=number, p=positive, s=string, etc...

[x] pull out PARSER as a subroutine.  Main loop parses stdin, and can 
    call parse(fd) to read in archives and devices.  Each parser has
    its own sense of "currep" and "layer", etc.

    parse gets called with currep pointer.  The main parse loop is
    called from lex.c (main()) which has a callback for xwin to use
    to find currep.  

    parse(FILE *fd, DB_TAB *currep, GLOBALS *globals);

    LEXER=token_stream_open(fd) /* make a lexical analyzer */
    token_get(word, LEXER);  	/* get tokens from stream */
    token_stream_close(LEXER);	/* destroy lexer (after EOF) */


[x] implement "ADD I NAME" syntax as synonym for "ADD NAME", use
regress/slic.d for testing.

[ ] implement typesetting functions "\d \u \jc" for down, up and center"
[ ] rubberbanding for text/notes
[ ] make note and text use the same geom_note/text.c file
[x] figure out an extension to flexibly use multiple fonts files

[x] add line number counting in token.c and give line numbered
    error messages when reading in a file

problems found using cells/hh.d for regression test.

[x] Need to accept .sname @dname options

[x] fix grid to be compatible with old style : xstep, ystep  xorig, yorig
    unless :g6 is given, then accept "xd yd xs ys xo yo" style

[x] all "expected this, got that" strings need to give line number in
    non-interactive mode, and state type of command being executed.

[p] implement com_show to turn off #A errors.

[p] implement com_lock

[x] implement com_level

[x] discriminate between "L1" and "L123b".  The first is a Line/layer and
    the second is a valid device name.

[x] add rubber band mode to WIN and double click to terminate pan and zoom
    to facilitate easy browsing.

[x] geom_circle crashes in rubber-band mode because draw doesn't have
    transform set... (fixed by removing matrix initialization from xwin.c
    and making db_render autonomous)

DO "save AS" function

Implement nrm() function to save sequences of cells , then do the RCS
thing.  Have a button: click to move forward and backwards versions. 
Major rev numbers are compatible, minor revs are not.  Higher versions
of min rev numbers are likely to be more and more stable.  You can jump
from prev major rev whenever you think there have been enough minor revs
to satisfy you.  You mostly learn about OS design by following the email
groups and watching the decisions being made. 

Rules of state machines:  every step MUST make forward progress.  Either
consuming a token, or changing state leading to consuming of a token.
Failure to preserve this property leads to infinite loops.

DO ALL POSSIBLE VARIATIONS OF Click, type, (EOC by double click, ";", or
CMD).


[x] polys should close automatically.

polys should terminate when xyn == xy1 or when xyn==xy(n-1) or EOC.

poly should translate to X polys rather than line drawing.

[x] parser breaks up words with embedded periods "a.d" comes out as "a" and
    an option ".d".  Fixed.  Instance names can now include ".".

[x] allow null layers, eg "ADD R 0,0" and have it default properly to last
    used layer or layer specified with "LAYER" command.

[ ] ADD R should not allow zero width or height rectangles.

[x] implement add I (instances)

TODO:

[x]  parse options

    implement selection, movement and deletion, edit in place.

[x] DONE: do_line, do_rect, do_circ, do_note, do_text, do_poly

[ ] implement interactive parsing for doc_arc, do_oval

    make a menu.c, menu.h to parse and write menu on screen

    Let a fxn button "peel back" pairs from
    the list so that lines, etc can be built and torn back
    interactively. 

-------------------------------------------------------------------------
Problems:

db_install wipes out old version.
-------------------------------------------------------------------------

[x]     double clicks terminate lines.

[x]     fix callback routines to parse a generalized db_deflist pointer.  
	Make db_render handle xor drawing for use as a callback renderer. 
	Make all primitives handle a (possibly) truncated list of x,y
	pairs concatenated with the current callback point.  Make parser
	keep track of x,y points in an abstract data type which is a
	linked list of pairs.  

[x]   	lex uses hand written lexer and rlgetc.c to parse input and
	produce tokens accessible with gettoken.  Make ungettoken,
	and rewrite com_add(), etc, to use token streams.

[x]   	mouse clicks get parsed by "int mouse_parse(x,y, &text)" which
	returns 0 for menu (with pick string *text), and 1-n for viewport
    	number, injecting transformed x,y into parser input stream. 

[x]   	implement scaling, rotation, mirroring, nesting level

-------------------------------------------
table driven command parser:

    struct transition_rule {
	int currstate;
	int nextstate;
	(int)() action;
	TOKEN nexttoken
    };
    
    struct transition_rule parsetab[] = {
	0,1,func1,EOC,
	0,2,func2,NUM,
	2,3,func3,OPT
    }; 

interpreted with a loop:

    while(!done) {
	state = parse_eval(parsetab, currstate, &token);
	switch (state) {
	    case ERR:
		break
	    case 1:
		break;
	    case 2:
		break;
	    default:
		break;
	}
    }

parse_eval calls gettoken and ungets token on error, prints "Expected:"
message and returns ERR.  Normal operation sets &token and returns
newstate.
-------------------------------------------

A stack structure to maintain nested edit context:
    struct db_context {
	char * curr_cell_name;
	int grid_x_origin;
	int grid_y_origin;
	int grid_delta_x;
	int grid_delta_y;
	int grid_skip_x;
	int grid_skip_y;
	int level;
	int lock;
	char *unit_name;		/* mils, inch, meter, etc. */
	int unit_resolution;		/* res = unit_name/unit_resolution */
	int modified;
    }

    with push, pop context routines;
    all updates need to be made viewport specific
    all viewports should be structs in a linked list with xmin, ymin, xmax, ymax

pig does not allow devices that have all-numeric names.  Fix with
start-conditions?  See tone.orig from BTE source for example using
TTL gate names like "7400".

